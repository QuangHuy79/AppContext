ğŸ§  Thiáº¿t káº¿ logic cho bÆ°á»›c 16 â€“ StatePersistenceContext
ğŸ¯ Má»¥c tiÃªu tá»•ng thá»ƒ
Giá»¯ cho toÃ n bá»™ AppState (hoáº·c cÃ¡c pháº§n quan trá»ng) tá»“n táº¡i giá»¯a cÃ¡c láº§n reload cá»§a á»©ng dá»¥ng â€” nghÄ©a lÃ :

Khi ngÆ°á»i dÃ¹ng refresh hoáº·c Ä‘Ã³ng/má»Ÿ láº¡i tab, toÃ n bá»™ state Ä‘Æ°á»£c khÃ´i phá»¥c.

KhÃ´ng gÃ¢y loop render, khÃ´ng lÆ°u nhá»¯ng pháº§n state táº¡m (nhÆ° loading, error).

Dá»… má»Ÿ rá»™ng cho giai Ä‘oáº¡n â€œAppRuntime v1â€ á»Ÿ bÆ°á»›c 18.

ğŸ—ï¸ 1. Pháº¡m vi lÆ°u trá»¯
Ta khÃ´ng cáº§n lÆ°u má»i thá»© trong AppState, chá»‰ nhá»¯ng pháº§n "bá»n vá»¯ng" (persistent).
Äá» xuáº¥t lÆ°u:

Context	Key lÆ°u trong localStorage	Má»¥c Ä‘Ã­ch
SettingsContext	"settings"	Theme, language, UI preference
AuthContext	"auth"	Token, user info (trá»« password)
CacheContext	"cache"	Dá»¯ liá»‡u cache táº¡m, náº¿u nháº¹
DataSyncContext	"dataSync"	(optional) thÃ´ng tin Ä‘á»“ng bá»™
ğŸ”¸ KhÃ´ng lÆ°u NetworkContext, DeviceContext, UIContext vÃ¬ chÃºng lÃ  â€œruntime onlyâ€.

ğŸ”„ 2. Luá»“ng Ä‘á»“ng bá»™
[AppProvider Mount] 
     â†“
StatePersistenceContext â†’ Ä‘á»c localStorage â†’ hydrate AppState
     â†“
Khi AppState thay Ä‘á»•i (debounced 500ms):
     â†“
StatePersistenceContext â†’ ghi láº¡i vÃ o localStorage
Khi app khá»Ÿi Ä‘á»™ng â†’ gá»i loadPersistedState()

Khi state thay Ä‘á»•i â†’ gá»i saveAppState()

CÃ³ thá»ƒ dÃ¹ng debounce (500ms) Ä‘á»ƒ giáº£m táº§n suáº¥t ghi localStorage.

âš™ï¸ 3. API ná»™i bá»™ cá»§a context
StatePersistenceContext sáº½ cung cáº¥p:

{
  persistedKeys,           // Danh sÃ¡ch key Ä‘Æ°á»£c quáº£n lÃ½
  loadPersistedState,      // HÃ m Ä‘á»c localStorage
  saveAppState,            // HÃ m lÆ°u AppState hiá»‡n táº¡i
  clearPersistedState,     // XÃ³a toÃ n bá»™ localStorage (hoáº·c theo key)
}
âš¡ Nhá»¯ng hÃ m nÃ y cÃ³ thá»ƒ gá»i tá»« toastService hoáº·c UIContext (vd: khi nháº¥n â€œXÃ³a Cacheâ€).

ğŸ§© 4. CÃ¡ch hook vÃ o AppProvider
Ta bá»c AppProvider cuá»‘i cÃ¹ng báº±ng StatePersistenceProvider, vÃ­ dá»¥:

<StatePersistenceProvider>
  <AppProvider>
    <App />
  </AppProvider>
</StatePersistenceProvider>
Hoáº·c náº¿u AppProvider lÃ  context chÃ­nh thÃ¬ ta chÃ¨n StatePersistenceContext bÃªn trong AppProvider, vÃ¬ nÃ³ cáº§n quyá»n truy cáº­p appState:

<AppProvider>
  <StatePersistenceProvider>
    <App />
  </StatePersistenceProvider>
</AppProvider>
CÃ¡ch nÃ y dá»… quáº£n lÃ½ hÆ¡n vÃ¬ cÃ³ thá»ƒ truy cáº­p trá»±c tiáº¿p appState Ä‘á»ƒ lÆ°u.

ğŸ§  5. CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng chi tiáº¿t
(a) Khi khá»Ÿi Ä‘á»™ng á»©ng dá»¥ng:

StatePersistenceProvider mount.

Gá»i loadPersistedState().

Tráº£ vá» object chá»©a cÃ¡c giÃ¡ trá»‹ Ä‘Æ°á»£c lÆ°u ({ settings, auth, cache }).

Dispatch vÃ o reducer toÃ n cá»¥c (appReducer) Ä‘á»ƒ hydrate state ban Ä‘áº§u.

(b) Khi appState thay Ä‘á»•i:

Sá»­ dá»¥ng useEffect trong StatePersistenceProvider.

Má»—i khi appState thay Ä‘á»•i (vÃ  cÃ³ key trong persistedKeys) â†’ serialize vÃ  lÆ°u vÃ o localStorage.

CÃ³ debounce Ä‘á»ƒ trÃ¡nh ghi liÃªn tá»¥c.

(c) Khi cáº§n xÃ³a cache:

Gá»i clearPersistedState() â†’ removeItem() cÃ¡c key Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh â†’ toast.info("Cache cleared").

ğŸ’¡ 6. Vá» serialization & an toÃ n dá»¯ liá»‡u
DÃ¹ng JSON.stringify() vÃ  JSON.parse() khi Ä‘á»c/ghi.

ThÃªm try/catch Ä‘á»ƒ trÃ¡nh lá»—i náº¿u localStorage bá»‹ khÃ³a/quÃ¡ Ä‘áº§y.

CÃ³ thá»ƒ versioning key Ä‘á»ƒ trÃ¡nh lá»—i schema khi nÃ¢ng cáº¥p app:

localStorage.setItem("app_v1_auth", JSON.stringify(data))
ğŸ§ª 7. Test coverage trong src/test/StatePersistence.test.jsx
CÃ¡c test chÃ­nh:

LÆ°u state â†’ reload â†’ khÃ´i phá»¥c Ä‘Ãºng giÃ¡ trá»‹.

XÃ³a cache â†’ localStorage rá»—ng.

KhÃ´ng gÃ¢y loop khi hydrate.

Ghi localStorage debounce (timeout test).